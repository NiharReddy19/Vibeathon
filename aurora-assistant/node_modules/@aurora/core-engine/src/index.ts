// File: packages/core-engine/src/index.ts
// Purpose: Main entry point - bootstrap HTTP and WebSocket servers

import http from 'http';
import { createHttpServer } from './api/http';
import { WSEventServer } from './api/ws';
import { config } from './utils/config';
import { logger } from './utils/logger';

async function startEngine() {
  try {
    logger.info('Starting Aurora Core Engine...');
    logger.info('Configuration:', { 
      port: config.port, 
      nodeEnv: config.nodeEnv,
      autostartSTT: config.autostartSTT 
    });

    // Create HTTP server
    const app = createHttpServer();
    const server = http.createServer(app);

    // Create WebSocket server
    const wsServer = new WSEventServer(server);

    // Start listening
    server.listen(config.port, () => {
      logger.info(`ðŸš€ Aurora Engine running on port ${config.port}`);
      logger.info(`   HTTP API: http://localhost:${config.port}`);
      logger.info(`   WebSocket: ws://localhost:${config.port}/v1/logs`);
      logger.info(`   Health check: http://localhost:${config.port}/health`);
    });

    // Graceful shutdown
    process.on('SIGTERM', () => {
      logger.info('SIGTERM received, shutting down gracefully...');
      wsServer.close();
      server.close(() => {
        logger.info('Server closed');
        process.exit(0);
      });
    });

  } catch (error) {
    logger.error('Failed to start engine:', error);
    process.exit(1);
  }
}

// Start the engine
startEngine();
