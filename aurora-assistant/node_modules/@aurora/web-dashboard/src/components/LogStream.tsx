import { WSMessage } from '@aurora/shared';
import { useEffect, useRef } from 'react';

interface LogStreamProps {
  messages: WSMessage[];
}

export default function LogStream({ messages }: LogStreamProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const autoScrollRef = useRef(true);

  useEffect(() => {
    if (autoScrollRef.current && containerRef.current) {
      containerRef.current.scrollTop = containerRef.current.scrollHeight;
    }
  }, [messages]);

  const handleScroll = () => {
    if (!containerRef.current) return;
    const { scrollTop, scrollHeight, clientHeight } = containerRef.current;
    autoScrollRef.current = scrollHeight - scrollTop - clientHeight < 50;
  };

  const formatTimestamp = (ts: number) => {
    return new Date(ts).toLocaleTimeString();
  };

  const renderPayload = (message: WSMessage) => {
    switch (message.type) {
      case 'stt.partial':
      case 'stt.final':
        return (
          <div className="log-payload">
            <span className="log-label">Text:</span>
            <span className="log-value">{message.payload.text}</span>
          </div>
        );
      
      case 'intent.preview':
        return (
          <div className="log-payload">
            <span className="log-label">Intent:</span>
            <span className="log-value">{message.payload.intent}</span>
            <span className="log-label">Confidence:</span>
            <span className="log-value">{(message.payload.confidence * 100).toFixed(1)}%</span>
            {Object.keys(message.payload.slots).length > 0 && (
              <>
                <span className="log-label">Slots:</span>
                <span className="log-value">{JSON.stringify(message.payload.slots)}</span>
              </>
            )}
          </div>
        );
      
      case 'action.result':
        return (
          <div className="log-payload">
            <span className="log-label">Status:</span>
            <span className={`log-badge ${message.payload.ok ? 'success' : 'error'}`}>
              {message.payload.ok ? 'Success' : 'Failed'}
            </span>
            {message.payload.data && (
              <>
                <span className="log-label">Data:</span>
                <span className="log-value">{JSON.stringify(message.payload.data)}</span>
              </>
            )}
          </div>
        );
      
      default:
        return <div className="log-payload">{JSON.stringify(message.payload)}</div>;
    }
  };

  return (
    <div className="log-stream" ref={containerRef} onScroll={handleScroll}>
      {messages.length === 0 ? (
        <div className="empty-state">Waiting for logs...</div>
      ) : (
        messages.map((message, idx) => (
          <div key={idx} className={`log-entry log-type-${message.type}`}>
            <div className="log-header">
              <span className="log-type">{message.type}</span>
              <span className="log-time">{formatTimestamp(message.timestamp)}</span>
            </div>
            {renderPayload(message)}
          </div>
        ))
      )}
    </div>
  );
}
